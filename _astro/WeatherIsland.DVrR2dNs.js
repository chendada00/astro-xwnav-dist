import{j as d}from"./jsx-runtime.D_zvdyIk.js";import{r as f}from"./index.BVOCwoKb.js";const j=36e5,p={晴:"☀️",多云:"⛅",阴:"☁️",小雨:"🌦️",中雨:"🌧️",大雨:"🌧️",雷:"⚡",雪:"❄️",雾:"🌫️",未知:"🌤️"};function N(r,h,v="",g=null){console.log("处理天气数据");const w=new Date,$=w.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),c=["日","一","二","三","四","五","六"],C=w.getFullYear()+"年"+(w.getMonth()+1)+"月"+w.getDate()+"日 星期"+c[w.getDay()]+" "+$;if(!r||r.error){console.error("天气数据获取失败",r?.error);const n=r&&r.reason?r.reason:"该位置暂不支持";return{location:v||"未知位置",condition:n,temperature:"N/A",tempRange:"N/A",airQuality:"N/A",time:$,fullDateTime:C,icon:p.未知}}const b=r.current||{},u=b.weather_code||0,_=b.temperature_2m!==void 0?`${Math.round(b.temperature_2m)}°C`:"N/A";let k="N/A";if(r.daily){const n=r.daily.temperature_2m_min?.[0],a=r.daily.temperature_2m_max?.[0];n!==void 0&&a!==void 0&&(k=`${Math.round(n)}~${Math.round(a)}°C`)}let y="N/A";r.current&&r.current.relative_humidity_2m!==void 0&&(y=`${r.current.relative_humidity_2m}%`);let e="N/A";if(r.current&&r.current.european_aqi!==void 0){const n=r.current.european_aqi;let a="";n<=20?a="优":n<=40?a="良":n<=60?a="中等":n<=80?a="一般":n<=100?a="差":a="严重",e=`${a} (${n})`}let t="未知",o=p.未知;return u!==void 0&&(u===0?(t="晴",o=p.晴):u===1?(t="大部晴朗",o=p.晴):u===2?(t="局部多云",o=p.多云):u===3?(t="多云",o=p.多云):[45,48].includes(u)?(t="雾",o=p.雾):[51,53,55,56,57].includes(u)?(t="小雨",o=p.小雨):[61,63,66,80,81].includes(u)?(t="中雨",o=p.中雨):[65,67,82].includes(u)?(t="大雨",o=p.大雨):[95,96,99].includes(u)?(t="雷雨",o=p.雷):[71,73,75,77,85,86].includes(u)?(t="雪",o=p.雪):(t="阴",o=p.阴)),{location:v||"未知位置",condition:t,temperature:_,tempRange:k,airQuality:e,humidity:y,time:$,fullDateTime:C,icon:o}}function R(){const[r,h]=f.useState({location:"",condition:"",temperature:"",tempRange:"",airQuality:"",time:"",fullDateTime:"",icon:"🌤️"}),[v,g]=f.useState(!0),[w,$]=f.useState(""),c=f.useRef({data:null,lastUpdated:0,location:"",coordinates:null}),C=async()=>{try{if(c.current.location&&c.current.coordinates)return console.log("使用缓存的位置信息和坐标"),{location:c.current.location,coordinates:c.current.coordinates};console.log("正在使用 api.myip.la 获取地区信息和坐标...");let e="",t=null;try{const o=new AbortController,n=setTimeout(()=>o.abort(),4e3),a=await fetch("https://api.myip.la/cn?json",{signal:o.signal,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36","Accept-Language":"zh-CN,zh;q=0.9"}});if(clearTimeout(n),a.ok){const i=await a.json();if(console.log("api.myip.la 返回数据:",i),i&&i.location){i.location.latitude&&i.location.longitude&&(t={latitude:parseFloat(i.location.latitude),longitude:parseFloat(i.location.longitude)},console.log(`从 api.myip.la 获取到坐标: ${t.latitude}, ${t.longitude}`));const l=i.location.province||"",s=i.location.city||"";l&&s?(s.includes(l.replace("省","").replace("市","").replace("都",""))?e=s:e=l+s,console.log(`从 api.myip.la 获取到位置: ${e}`)):l?e=l:s?e=s:i.location.country_name&&(e=i.location.country_name)}}}catch(o){console.warn("api.myip.la 获取失败，将回退到备用方案:",o.message)}if(!e){console.log("正在使用备用 API myip.ipip.net 获取地区信息...");try{const o=await fetch("https://myip.ipip.net",{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36",Referer:"https://www.baidu.com/","Accept-Language":"zh-CN,zh;q=0.9","Keep-Alive":"yes","Cache-Control":"no-cache"}});if(o.ok){const n=await o.text();if(console.log("myip.ipip.net 返回数据:",n),n&&n.includes("来自于：")){const a=n.split("来自于：")[1];if(a){const i=a.split("  ")[0];if(i){const l=i.trim().split(" ");l.length>=3?e=l[1]+l[2]:l.length===2?e=l[1]:e=l[0],console.log(`从 myip.ipip.net 获取到位置: ${e}`);try{console.log(`正在使用 OpenStreetMap 获取 ${e} 的坐标...`),t=await b(e),t&&console.log(`成功获取 ${e} 的坐标: ${t.latitude}, ${t.longitude}`)}catch(s){console.error(`获取 ${e} 坐标失败:`,s)}}}}}}catch(o){console.error("备用 API 也失败了:",o.message)}}return e?(console.log(`最终使用的位置: ${e}`),c.current.location=e,c.current.coordinates=t,$(e),{location:e,coordinates:t}):(console.warn("无法获取位置信息"),{location:"",coordinates:null})}catch(e){return console.error("获取位置信息过程中发生错误:",e),{location:"",coordinates:null}}},b=async e=>{if(!e)return null;try{const t=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(e)}&format=json&limit=1&accept-language=zh-Hans&countrycodes=CN`;console.log(`正在获取 ${e} 的坐标...`);const o=await fetch(t,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36","Accept-Language":"zh-CN,zh;q=0.9"}});if(!o.ok)throw new Error("地理编码请求失败");const n=await o.json();if(n&&n.length>0){const{lat:a,lon:i}=n[0];return console.log(`获取到 ${e} 的坐标: ${a}, ${i}`),{latitude:parseFloat(a),longitude:parseFloat(i)}}if(e.length>2){const a=e.substring(0,2);console.log(`尝试使用省份名称获取坐标: ${a}`);const i=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(a)}&format=json&limit=1&accept-language=zh-Hans&countrycodes=CN`,l=await fetch(i,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36","Accept-Language":"zh-CN,zh;q=0.9"}});if(l.ok){const s=await l.json();if(s&&s.length>0){const{lat:x,lon:A}=s[0];return console.log(`使用省份 ${a} 的坐标: ${x}, ${A}`),{latitude:parseFloat(x),longitude:parseFloat(A)}}}}return console.warn(`无法获取 ${e} 的坐标，天气服务暂不支持该地区`),null}catch(t){return console.error("获取坐标失败:",t),null}},u=f.useRef(!1),_=f.useRef(0),k=5e3,y=async()=>{if(u.current){console.log("天气API调用正在进行中，跳过重复请求");return}const e=Date.now();if(e-_.current<k){console.log("天气API调用过于频繁，跳过请求");return}u.current=!0,_.current=e,g(!0);try{if(c.current.data&&e-c.current.lastUpdated<j){console.log("使用缓存的天气信息"),h(c.current.data),g(!1),u.current=!1;return}const{location:t,coordinates:o}=await C();if(console.log(`获取到位置: ${t}`),!t){const m=N({error:!0,reason:"该位置暂不支持"},e,"未知位置");h(m),g(!1);return}if(!o){const m=N({error:!0,reason:"无法获取该位置的坐标"},e,t);h(m),g(!1);return}const n=`https://api.open-meteo.com/v1/forecast?latitude=${o.latitude}&longitude=${o.longitude}&current=temperature_2m,weather_code,relative_humidity_2m&daily=temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=1`,a=`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${o.latitude}&longitude=${o.longitude}&current=european_aqi&timezone=auto`;console.log("正在获取天气信息..."),console.log("天气 API URL:",n),console.log("空气质量 API URL:",a);const i=new AbortController,l=setTimeout(()=>i.abort(),4e3),s=await fetch(n,{signal:i.signal,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36","Accept-Language":"zh-CN,zh;q=0.9"}});if(clearTimeout(l),!s.ok)throw new Error(`获取天气信息失败: ${s.status} ${s.statusText}`);const x=await s.json();console.log("天气数据获取成功:",x);let A={current:{european_aqi:null}};try{const m=new AbortController,L=setTimeout(()=>m.abort(),5e3),T=await fetch(a,{signal:m.signal,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36","Accept-Language":"zh-CN,zh;q=0.9"}});clearTimeout(L),T.ok?(A=await T.json(),console.log("空气质量数据获取成功:",A)):console.warn(`获取空气质量信息失败: ${T.status} ${T.statusText}`)}catch(m){console.warn("获取空气质量数据时出错:",m)}const I={...x,current:{...x.current,european_aqi:A.current?.european_aqi}},W=N(I,e,t,o);c.current.data=W,c.current.lastUpdated=e,h(W),g(!1)}catch(t){console.error("获取天气信息失败:",t);const o=N({error:!0,reason:t.message},Date.now(),c.current.location||"未知位置");h(o),g(!1)}finally{u.current=!1}};return f.useEffect(()=>{let e=!0,t=null;const o=()=>{e&&("requestIdleCallback"in window?window.requestIdleCallback(()=>{e&&y()}):setTimeout(()=>{e&&y()},1e3))};return t=()=>{if(!e||document.visibilityState!=="visible")return;const n=Date.now();(!c.current.data||n-c.current.lastUpdated>j)&&(console.log("页面可见，检查是否需要更新天气信息"),y())},o(),document.addEventListener("visibilitychange",t,{passive:!0}),()=>{e=!1,t&&document.removeEventListener("visibilitychange",t)}},[]),d.jsx("div",{className:"mb-6 p-4 bg-gray-50/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl border border-black/5 dark:border-white/10 shadow-[0_2px_8px_rgba(0,0,0,0.06)] dark:shadow-[0_2px_8px_rgba(0,0,0,0.15)]",children:d.jsxs("div",{className:"flex items-center justify-center",children:[d.jsx("span",{className:"text-2xl mr-3",children:r.icon}),d.jsxs("div",{className:"text-sm",children:[d.jsx("div",{className:"font-medium",children:"当地天气"}),v?d.jsxs("div",{className:"text-gray-600 dark:text-gray-300 flex items-end",children:["加载中",d.jsx("span",{className:"inline-block ml-px font-bold animate-wave",children:"."}),d.jsx("span",{className:"inline-block ml-px font-bold animate-wave [animation-delay:0.1s]",children:"."}),d.jsx("span",{className:"inline-block ml-px font-bold animate-wave [animation-delay:0.2s]",children:"."})]}):d.jsxs(d.Fragment,{children:[d.jsx("div",{className:"text-gray-600 dark:text-gray-300",children:`${r.location}: ${r.condition} ${r.temperature}`}),d.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:`${r.tempRange} | 空气质量: ${r.airQuality} | 湿度: ${r.humidity}`}),r.fullDateTime&&d.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400","data-component-name":"WeatherIsland",children:`${r.fullDateTime}`})]})]})]})})}export{R as default};
